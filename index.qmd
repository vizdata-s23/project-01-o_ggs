---
title: "Project title"
subtitle: "STA/ISS 313 - Project 1"
author: "The O_GGS"
format: html
editor: visual
---

```{r}
#| label: load-pkgs-data
#| warning: false
#| message: false

library(tidyverse)
library(janitor)
library(maps)
library(viridis)

chocolate <- read_csv("data/flavors_of_cacao.csv")

con2cont <- read_csv("data/countryContinent.csv")

world <- map_data("world")
```

```{r}
#| label: setup-global-options
opts <- options()  # save old options

options(ggplot2.continuous.colour="viridis")
options(ggplot2.continuous.fill = "viridis")
```

```{r}
#| label: data-cleaning

chocolate <- chocolate |>
  clean_names() |>
  mutate(
    company_location_country = case_when(
      company_location == "U.S.A." ~ "United States of America",
      company_location == "U.K." ~ "United Kingdom of Great Britain and Northern Ireland",
      company_location == "Wales" ~ "United Kingdom of Great Britain and Northern Ireland",
      company_location == "Scotland" ~ "United Kingdom of Great Britain and Northern Ireland",
      company_location == "Russia" ~ "Russian Federation",
      company_location == "South Korea" ~ "Korea (Republic of)",
      company_location == "Amsterdam" ~ "Netherlands",
      company_location == "Sao Tome" ~ "Sao Tome and Principe",
      company_location == "Bolivia" ~ "Bolivia (Plurinational State of)",
      company_location == "Venezuela" ~ "Venezuela (Bolivarian Republic of)",
      company_location == "St. Lucia" ~ "Saint Lucia",
      company_location == "Vietnam" ~ "Viet Nam",
      company_location == "Domincan Republic" ~ "Dominican Republic",
      company_location == "Niacragua" ~ "Nicaragua",
      company_location == "Eucador" ~ "Ecuador",
      TRUE ~ company_location
    ),
    cocoa_percent = as.numeric(sub("%", "", cocoa_percent))
    )

con2cont <- con2cont |>
  select(country, continent)

con2cont <- con2cont |>
  rename(company_location_country = country)

```

```{r}
#| label: merging-data
#| message: false

chocolate_merged <- chocolate |>
  left_join(con2cont,
            multiple = "all")
```

## Abstract

In this project, we aim to explore what characteristics (as identified by experts) of chocolate bars lead to the most successful chocolate bars and how expert opinions of these characteristics have changed over time. INSERT RESULTS HERE

------------------------------------------------------------------------

## Introduction

(1-2 paragraphs): Brief introduction to the dataset. You may repeat some of the information about the dataset provided in the introduction to the dataset on the TidyTuesday repository, paraphrasing on your own terms. Imagine that your project is a standalone document and the grader has no prior knowledge of the dataset.

Our main dataset is the `chocolate` dataset. It contains information about chocolate bars and reviews written by experts. It contains `r ncol(chocolate)` variables with `r nrow(chocolate)` observations. This dataset contains information about the company who makes the chocolate bars, the percent of cocoa, where the company is located, bean type & origin, expert review (out of 5 stars), and the date and reference number for each review. The original data source can be found [here](https://www.kaggle.com/code/willcanniford/chocolate-bar-ratings-extensive-eda/data) and more in depth information can be found in our data dictionary located in `data/README.md` in this repository.

Our other datasets include `world` and `con2cont` and they are primarily used in our plots that include geospatial variables....

## Question 1: What characteristics lead to the most successful chocolate bars?

### Introduction

(1-2 paragraphs): Introduction to the question and what parts of the dataset are necessary to answer the question. Also discuss why you're interested in this question.

We aim to explore what characteristics of chocolate bars are the most successful as rated out of 5 stars by experts. This information is important for consumers so when they are in the candy aisle at grocery stores faced with dozens of options, they can use these findings to make a well-informed decision about which chocolate they should buy. This is also important for chocolate makers to understand so that they can use this information to improve their own chocolate given the location preferences.

To answer what characteristics lead to the most successful chocolate bars we will use the variables that describe cocoa percentage in the chocolate, the various companies who are included in this dataset, the origin of the cocoa beans that are used to produce that chocolate bar, and the expert reviews of the chocolate bars.

### Approach

(1-2 paragraphs): Describe what types of plots you are going to make to address your question. For each plot, provide a clear explanation as to why this plot (e.g. boxplot, barplot, histogram, etc.) is best for providing the information you are asking about. The two plots should be of different types, and at least one of the two plots needs to use either color mapping or facets.

### Analysis

(2-3 code blocks, 2 figures, text/code comments as needed): In this section, provide the code that generates your plots. Use scale functions to provide nice axis labels and guides. You are welcome to use theme functions to customize the appearance of your plot, but you are not required to do so. All plots must be made with **ggplot2**. Do not use base R or lattice plotting functions.

Dani's Plot

```{r}
choc_by_company_local <- chocolate_merged |>
  filter(
    company_location %in% c(
      "U.S.A.", "France", "Canada", "U.K.", "Italy", "Ecuador",
      "Australia", "Belgium", "Switzerland", "Germany"
  )) |>
  mutate(cocoa_percentage = cocoa_percent /100)

ggplot(choc_by_company_local,
       aes(x = cocoa_percentage, y = rating, color = company_location)) +
  geom_point(alpha = 0.3) +
  geom_smooth(se = FALSE) +
  scale_x_continuous(labels = scales::percent_format(accuracy =1)) +
  theme_minimal() +
  labs(
    x = "Percentage of Cocoa",
    y = "Rating (From 1-5)",
    title = "Cocoa Percentages Vs Ratings",
    subtitle = "Top ten chocolate companies in number of reviews",
    color = "Chocolate Company Locations"
  )
```

```{r}
world_df <- left_join(world, chocolate|>
                        group_by(broad_bean_origin)|>
                        summarise(rating = mean(rating)), by = c("region" ="broad_bean_origin"))

label_df <- world_df |>
  filter(!is.na(rating)) |>
  group_by(region) |>
  summarise(rating = mean(rating), long = mean(long), lat = mean(lat), .groups = "drop")

world_df|>
  filter(region!="Antarctica")|>
  ggplot() +
  aes(x = long, y = lat, group = group, fill = rating) +
  geom_polygon(color="black", size = 0.2) +
  scale_fill_gradient(limits = c(3, 3.5)) +
  theme_void()+
  theme(panel.background = element_rect(fill = "light blue")) +
  geom_text(data = label_df, aes(x = long, y = lat, label = region), size = 3, 
            hjust = 0.5, vjust = 0.5, inherit.aes = FALSE,
            color = "white", fontface = "bold", check_overlap = TRUE)
```

### Discussion

(1-3 paragraphs): In the Discussion section, interpret the results of your analysis. Identify any trends revealed (or not revealed) by the plots. Speculate about why the data looks the way it does.

## Question 2: Title that relates to the question you're answering

### Introduction

(1-2 paragraphs): Introduction to the question and what parts of the dataset are necessary to answer the question. Also discuss why you're interested in this question.

### Approach

(1-2 paragraphs): Describe what types of plots you are going to make to address your question. For each plot, provide a clear explanation as to why this plot (e.g. boxplot, barplot, histogram, etc.) is best for providing the information you are asking about. The two plots should be of different types, and at least one of the two plots needs to use either color mapping or facets.

To create the first plot, we created line plots by year that show the relationship between the cocoa percentage of the chocolate bar and their ratings. In creating the variable with year information that will be used in faceting the plots, we grouped the year information provided in `review_date` into two year increments to create a new character variable (`year_even`) using the mutate function. We made this choice as 12 separate graphs (one for each year instead of for two years) would provide too much clutter, and it would be hard to visualize the trends across time. We also made a new variable, `avg_rating`, that stores the average rating for a cocoa percentage in a certain year by grouping the data by `year_even` and `cocoa_percentage`. For the plot, our x-axis variable is the cocoa percentage and the y-axis variable is the rating. The plot will be faceted into 6 time periods assigned within 2006 \~ 2017. We created linear line graphs and scatterplots so we can see the overall trend of how ratings change as the cocoa percentage changes as well as some variation in the data, and we faceted by time periods how this relationship changed as time changed.

### Analysis

(2-3 code blocks, 2 figures, text/code comments as needed): In this section, provide the code that generates your plots. Use scale functions to provide nice axis labels and guides. You are welcome to use theme functions to customize the appearance of your plot, but you are not required to do so. All plots must be made with **ggplot2**. Do not use base R or lattice plotting functions.

```{r}
#| label: plot2.victoria
#| warning: false
#| message: false

chocolate_merged1 <- chocolate_merged |>
  mutate(
    year_even = case_when(
      review_date == 2006 | review_date == 2007 ~ "2006-7",
      review_date == 2008 | review_date == 2009 ~ "2008-9",
      review_date == 2010 | review_date == 2011 ~ "2010-11",
      review_date == 2012 | review_date == 2013 ~ "2012-13",
      review_date == 2014 | review_date == 2015 ~ "2014-15",
      review_date == 2016 | review_date == 2017 ~ "2016-17"
    )
  ) |>
  group_by(year_even, cocoa_percent) |>
  mutate(avg_rating = mean(rating),
         cocoa_percent = as.numeric(sub("%", "", cocoa_percent))) 

ggplot(chocolate_merged1, mapping = aes(x = cocoa_percent, y = avg_rating)) +
  geom_point() +
  geom_smooth(aes(color = year_even), method  = "lm", se = FALSE, show.legend = FALSE) +
  facet_grid(year_even ~., scales = "free_x") + 
  theme_minimal() + 
  theme(aspect.ratio = 1/8) +
  scale_y_continuous(breaks = c(1,2,3,4,5)) +
  labs(x = "Percentage of Cocoa in Chocolate", 
       y = "Average Rating", title = "How well Cocoa Percentages are Rated", 
       subtitle = "By year, from 2006 to 2017", color = "Year")

```

Q2 - Plot 2 (Minwoo)

```{r}
chocolate_merged1 <- chocolate_merged1 |>
  mutate(
    rating_bin = case_when(
      rating >= 0.00 & rating <= 0.50 ~ "0.00 ~ 0.50",
      rating > 0.50 & rating <= 1.00 ~ "0.50 ~ 1.00",
      rating > 1.00 & rating <= 1.50 ~ "1.00 ~ 1.50",
      rating > 1.50 & rating <= 2.00 ~ "1.50 ~ 2.00",
      rating > 2.00 & rating <= 2.50 ~ "2.00 ~ 2.50",
      rating > 2.50 & rating <= 3.00 ~ "2.50 ~ 3.00",
      rating > 3.00 & rating <= 3.50 ~ "3.00 ~ 3.50",
      rating > 3.50 & rating <= 4.00 ~ "3.50 ~ 4.00",
      rating > 4.00 & rating <= 4.50 ~ "4.00 ~ 4.50",
      rating > 4.50 & rating <= 5.00 ~ "4.50 ~ 5.00"
    )
  )

ggplot(chocolate_merged1, aes(x = factor(rating_bin), fill = continent)) +
  geom_bar(position="fill", stat = "count") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  coord_flip() +
  facet_grid(. ~ year_even) +
  theme_minimal() +
  scale_fill_viridis_d() +
  guides(fill = guide_legend(title = "Continent")) +
  theme(panel.spacing = unit(1, "lines"), panel.border = element_rect(color = "black", fill = NA, size = 0.05)) +
  labs(x = "Rating", y = "Percentage", title = "Proportion of Continents For Each Rating Group", subtitle = "By year, from 2006 to 2017")
```

```{r}
chocolate_merged1 <- chocolate_merged1 |>
  mutate(
    rating_bin = case_when(
      rating >= 0.00 & rating <= 0.50 ~ "0.00 ~ 0.50",
      rating > 0.50 & rating <= 1.00 ~ "0.50 ~ 1.00",
      rating > 1.00 & rating <= 1.50 ~ "1.00 ~ 1.50",
      rating > 1.50 & rating <= 2.00 ~ "1.50 ~ 2.00",
      rating > 2.00 & rating <= 2.50 ~ "2.00 ~ 2.50",
      rating > 2.50 & rating <= 3.00 ~ "2.50 ~ 3.00",
      rating > 3.00 & rating <= 3.50 ~ "3.00 ~ 3.50",
      rating > 3.50 & rating <= 4.00 ~ "3.50 ~ 4.00",
      rating > 4.00 & rating <= 4.50 ~ "4.00 ~ 4.50",
      rating > 4.50 & rating <= 5.00 ~ "4.50 ~ 5.00"
    )
  )

ggplot(chocolate_merged1, aes(x = factor(rating_bin), fill = continent)) +
  geom_bar(position="fill", stat = "count") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  facet_grid(year_even ~ .) +
  theme_minimal() +
  scale_fill_viridis_d() +
  guides(fill = guide_legend(title = "Continent")) +
  theme(panel.spacing = unit(1, "lines"), panel.border = element_rect(color = "black", fill = NA, size = 0.05)) +
  labs(x = "Rating", y = "Percentage", title = "Proportion of Continents For Each Rating Group", subtitle = "By year, from 2006 to 2017")
```

### Discussion

(1-3 paragraphs): In the Discussion section, interpret the results of your analysis. Identify any trends revealed (or not revealed) by the plots. Speculate about why the data looks the way it does.

Based on the first plot, it can be seen that in general, as the percentage of cocoa increases, the ratings tend to decrease, indicating that people tend to prefer chocolate with less cocoa in it. However, this trend has lessened as time has progressed. In 2016-2017, there is no clear preference for chocolate with higher or lower cocoa percentages, but in 2006-2007, the data clearly indicates a preference for chocolate with lower cocoa percentage. Additionally, the data does not seem to contain much chocolate with less than 50% cocoa, as these chocolates only have data in 2010 to 2013. This may be an indication that chocolate companies produced more low cocoa chocolate during those years, but it could just be a lack of observations in this data set.
